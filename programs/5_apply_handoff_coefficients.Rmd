---
title: "Application of handoff coefficients"
author: "B Steele"
date: "2023-03-31"
output: html_document
---

```{r}
library(tidyverse)

#point to directories
rs_dir = 'data/upstreamRS/'

```

# Purpose

This script applies the Gardener lab US hand-off coefficients to the Yojoa LS stack.

## Load files

```{r}
handoff = read.csv(file.path(rs_dir, 'LC02_Corr_Coef.csv')) %>% 
  mutate(mission = case_when(sat == 'LT05' ~ 'LANDSAT_5',
                             sat == 'LE07' ~ 'LANDSAT_7',
                             sat == 'LC08' ~ 'LANDSAT_8',
                             sat == 'LC09' ~ 'LANDSAT_9',
                             TRUE ~ ''))

yojoa_rs = read.csv(file.path(rs_dir, 'Yojoa_LandsatC2_SRST_filtered_v2023-03-31.csv'))

```

Because we're really only applying corrections to the median band values, let's drop all the others and pull the date/loc/mission to the front

```{r}
yojoa_rs_sub = yojoa_rs %>% 
  select(date, location, mission,
         med_Blue:med_SurfaceTemp,
         prop_clouds:system.index,
         CLOUD_COVER:SUN_ELEVATION)
```

## Apply coefficients

We'll use the regional coefficients to calculate Rrs values for LS 5, 8, 9 as relative values to LS 7.

Let's re-orient the handoff calcs so that we can just join with the upstream dataset and apply in a single step.

```{r}
handoff_h = handoff %>% 
  pivot_longer(names_to = 'coeff',
               values_to = 'value',
               cols = c('intercept', 'coef1', 'coef2')) %>% 
  pivot_wider(names_from = c('band', 'coeff'),
              values_from = 'value')
```

Now join with the rs subset

```{r}
yojoa_rs_sub = full_join(yojoa_rs_sub, handoff_h)
```

And apply the coefficients, and fill in LS 7 as corrected (all values are corrected *to* LS 7 values)

```{r}
yojoa_rs_sub = yojoa_rs_sub %>% 
  mutate(med_Blue_corr = Blue_intercept + Blue_coef1*med_Blue + Blue_coef2*med_Blue^2,
         med_Red_corr = Red_intercept + Red_coef1*med_Red + Red_coef2*med_Red^2,
         med_Green_corr = Green_intercept + Green_coef1*med_Green + Green_coef2*med_Green^2,
         med_Nir_corr = Nir_intercept + Nir_coef1*med_Nir + Nir_coef2*med_Nir^2,
         med_Swir1_corr = Swir1_intercept + Swir1_coef1*med_Swir1 + Swir1_coef2*med_Swir1^2,
         med_Swir2_corr = Swir2_intercept + Swir2_coef1*med_Swir2 + Swir2_coef2*med_Swir2^2) 
```

## Export file

```{r}
yojoa_rs_sub %>% 
  filter(mission != 'LANDSAT_4') %>% 
  select(date, location, mission,
         med_Blue_corr:med_Swir2_corr, 
         prop_clouds:SUN_ELEVATION) %>% 
  write.csv(., file.path('data/upstreamRS/', paste0('yojoa_LandsatC2_SR_rrs_us_corr_v', Sys.Date(), '.csv')), row.names = F)
```
